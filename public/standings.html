<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Standings</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <nav class="nav">
        <a href="/index.html">Home</a>
        <a href="/tournaments.html">Tournaments</a>
        <a href="/standings.html">Standings</a>
        <a href="/login.html">Login</a>
    </nav>
    <hr>

    <h1>Tournament Standings</h1>

    <select id="tSelect"></select>
    <button onclick="loadStandings()">Load</button>

    <table border="1" cellpadding="6" style="margin-top:10px">
        <thead>
            <tr>
                <th>Team</th>
                <th>G</th>
                <th>W</th>
                <th>D</th>
                <th>L</th>
                <th>GF</th>
                <th>GA</th>
                <th>GD</th>
                <th>Pts</th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>

    <script>
        function apiFetch(url, options = {}) {
            return fetch(url, { credentials: "include", ...options });
        }

        async function safeJson(res) {
            try { return await res.json(); } catch { return null; }
        }

        function setStatus(msg) {
            const el = document.getElementById("statusText");
            if (el) el.textContent = msg;
        }

        async function loadTournaments() {
            setStatus("Loading tournaments...");

            const res = await apiFetch("/api/tournaments?limit=50");
            const data = await safeJson(res);

            if (!res.ok) {
                setStatus(`Error: ${data?.error || data?.message || res.status}`);
                alert("Login first, then open Standings page.");
                return;
            }

            const tournaments = data?.items ?? data; // ✅ поддержка пагинации И массива

            const sel = document.getElementById("tSelect");
            sel.innerHTML = "";

            if (!Array.isArray(tournaments) || tournaments.length === 0) {
                sel.innerHTML = `<option value="">No tournaments</option>`;
                setStatus("No tournaments yet");
                return;
            }

            tournaments.forEach(t => {
                const opt = document.createElement("option");
                opt.value = t._id;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });

            setStatus("Tournaments loaded ✅");
        }

        async function loadStandings() {
            const tid = document.getElementById("tSelect").value;
            if (!tid) return alert("Select tournament first");

            setStatus("Loading standings...");

            const res = await apiFetch(`/api/tournaments/${tid}/standings`);
            const data = await safeJson(res);

            if (!res.ok) {
                setStatus(`Error: ${data?.error || data?.message || res.status}`);
                return;
            }

            const standings = data?.standings ?? data; // ✅ если вдруг вернётся просто массив
            if (!Array.isArray(standings)) {
                setStatus("Standings format error");
                return;
            }

            const tbody = document.getElementById("standingsBody");
            tbody.innerHTML = "";

            standings.forEach(row => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
        <td>${row.teamName}</td>
        <td>${row.games}</td>
        <td>${row.wins}</td>
        <td>${row.draws}</td>
        <td>${row.losses}</td>
        <td>${row.goalsFor}</td>
        <td>${row.goalsAgainst}</td>
        <td>${row.goalDiff}</td>
        <td>${row.points}</td>
      `;
                tbody.appendChild(tr);
            });

            setStatus("Standings loaded ✅");
        }

        // expose
        window.loadStandings = loadStandings;

        // start
        loadTournaments();
    </script>

</body>

</html>